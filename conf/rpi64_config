# /bin/sh

MACHINE=$1

source ./sources/poky/oe-init-build-env $MACHINE

bitbake-layers add-layer \
../sources/meta-raspberrypi \
../sources/meta-openembedded/meta-filesystems \
../sources/meta-openembedded/meta-oe \
../sources/meta-openembedded/meta-multimedia \
../sources/meta-openembedded/meta-networking \
../sources/meta-openembedded/meta-python \
../sources/meta-openembedded/meta-perl \
../sources/meta-security \
../sources/meta-selinux \
../sources/meta-clang \
../sources/meta-flutter \
../sources/meta-vulkan \
../sources/meta-rust \
../sources/meta-webthings

sed -i "s|MACHINE ??= \"qemux86-64\"|MACHINE ?= \"$MACHINE\"|g" conf/local.conf

cat <<EOT >> conf/local.conf

INHERIT += "rm_work"

BBMASK = "meta-networking/recipes-kernel/wireguard"

DISTRO_FEATURES_remove = " sysvinit x11"
DISTRO_FEATURES_append = " alsa bluetooth usbhost opengl systemd"

INIT_MANAGER = "systemd"
VIRTUAL-RUNTIME_init_manager = "systemd"
VIRTUAL-RUNTIME_initscripts = ""

DISTRO_FEATURES_append=" pam selinux"
DISTRO_FEATURES_BACKFILL_CONSIDERED = ""

COMBINED_FEATURES += "alsa "
MACHINE_FEATURES_remove = "apm"

PREFERRED_PROVIDER_jpeg = "libjpeg-turbo"
PREFERRED_PROVIDER_jpeg-native = "libjpeg-turbo-native"

DISABLE_OVERSCAN = "1"
DISABLE_RPI_BOOT_LOGO = "1"
DISABLE_SPLASH = "1"
ENABLE_SPI_BUS = "1"
ENABLE_I2C = "1"
ENABLE_UART = "0"
SERIAL_CONSOLES = ""

GPU_MEM = "256"
KERNEL_MODULE_AUTOLOAD_raspberrypi4-64 += "i2c-dev i2c-bcm2708"
DISPMANX_OFFLINE = "1"
LINUX_KERNEL_TYPE = "preempt-rt"
CMDLINE_DEBUG = "quiet"

DEFAULT_TIMEZONE = "America/Los_Angeles"

ENABLE_BINARY_LOCALE_GENERATION = "1"
GLIBC_GENERATE_LOCALES = "en_US.UTF-8 es_US.UTF-8 en_GB.UTF-8"
IMAGE_LINGUAS ?= "en-us es-us en-gb"

CORE_IMAGE_EXTRA_INSTALL += " \
  kernel-modules \
  packagegroup-core-selinux \
  avahi-daemon \
  adwaita-icon-theme-cursors \
  xdg-user-dirs \
  tzdata-core \
"

EOT
